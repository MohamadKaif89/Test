<script>
  const threeSholdPrice = {{ settings.free_gift_threshold }};
  const variantId = {{ freeproduct.selected_or_first_available_variant.id }};
  const showProgress = {{ settings.free_gift_show_progress | json }};
  const progressText = "{{ settings.free_gift_progress_message }}";

  console.log("Free Gift script loaded");

  let isRunning = false;

  async function getCartData() {
    console.log("Fetching cart data");
    const res = await fetch('/cart.js', { cache: 'no-store' });
    return res.json();
  }

  async function addFreeGift() {
    console.log("Adding free gift");
    await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: variantId,
        quantity: 1,
        properties: { _free_gift: 'true' }
      })
    });
  }

  async function removeFreeGift(lineKey) {
    console.log("Removing free gift");
    await fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: lineKey,
        quantity: 0
      })
    });
  }

  async function handleFreeGift() {
    if (isRunning) {
      console.log("Already running, skip");
      return;
    }

    isRunning = true;

    const cart = await getCartData();
    const cartTotalPr = Number((cart.total_price / 100).toFixed(2));

    console.log("Cart total:", cartTotalPr);

    const giftItem = cart.items.find(
      item => item.variant_id == variantId
    );

    const giftMsg = document.getElementById('free-gift-message');
    const progressMsg = document.getElementById('free-gift-progress');

    // ===== THRESHOLD MET =====
    if (cartTotalPr >= threeSholdPrice) {
      console.log("Threshold met");

      giftMsg.style.display = 'block';
      progressMsg.style.display = 'none';

      if (!giftItem) {
        await addFreeGift();
      }
    }
    // ===== BELOW THRESHOLD =====
    else {
      console.log("Below threshold");

      giftMsg.style.display = 'none';

      if (showProgress) {
        const remaining = (threeSholdPrice - cartTotalPr).toFixed(2);
        progressMsg.innerText =
          progressText.replace('{{amount}}', remaining);
        progressMsg.style.display = 'block';
      }

      if (giftItem) {
        await removeFreeGift(giftItem.key);
      }
    }

    isRunning = false;
  }

  /* ---------- WHEN TO RUN ---------- */

  // 1. Page load
  document.addEventListener('DOMContentLoaded', handleFreeGift);

  // 2. Quantity change buttons
  document.addEventListener('click', function (e) {
    if (
      e.target.closest('[name="plus"]') ||
      e.target.closest('[name="minus"]') ||
      e.target.closest('.cart-remove')
    ) {
      console.log("Cart interaction detected");
      setTimeout(handleFreeGift, 500);
    }
  });
</script>
