{% if settings.free_gift_enable and settings.free_gift_product %}
  <div
    id="free-gift-config"
    data-enabled="true"
    data-threshold="{{ settings.free_gift_threshold | times: 100 }}"
    data-variant-id="{{ settings.free_gift_product.selected_or_first_available_variant.id }}"
    data-message="{{ settings.free_gift_message }}"
    data-show-progress="{{ settings.free_gift_show_progress }}"
    data-progress-message="{{ settings.free_gift_progress_message }}">
  </div>

  <p id="free-gift-message" style="margin-top:10px;"></p>
{% endif %}

<script src="{{ 'free-gift.js' | asset_url }}" defer></script>
document.addEventListener('DOMContentLoaded', function () {

  const config = document.getElementById('free-gift-config');
  const messageEl = document.getElementById('free-gift-message');
  if (!config) return;

  const ENABLED = config.dataset.enabled === 'true';
  const THRESHOLD = Number(config.dataset.threshold);
  const GIFT_VARIANT_ID = Number(config.dataset.variantId);
  const UNLOCK_MSG = config.dataset.message;
  const SHOW_PROGRESS = config.dataset.showProgress === 'true';
  const PROGRESS_MSG = config.dataset.progressMessage;

  if (!ENABLED || !GIFT_VARIANT_ID) return;

  async function getCart() {
    const res = await fetch('/cart.js');
    return res.json();
  }

  function findGift(cart) {
    return cart.items.find(item => item.variant_id === GIFT_VARIANT_ID);
  }

  async function addGift() {
    await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: GIFT_VARIANT_ID, quantity: 1 })
    });
  }

  async function removeGift() {
    await fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id: GIFT_VARIANT_ID, quantity: 0 })
    });
  }

  async function updateMessage(cart) {
    if (!messageEl) return;

    if (cart.items_subtotal_price >= THRESHOLD) {
      messageEl.textContent = UNLOCK_MSG;
    } else if (SHOW_PROGRESS) {
      const diff = Math.ceil((THRESHOLD - cart.items_subtotal_price) / 100);
      messageEl.textContent = PROGRESS_MSG.replace('{{amount}}', diff);
    } else {
      messageEl.textContent = '';
    }
  }

  async function handleFreeGift() {
    const cart = await getCart();
    const gift = findGift(cart);
    const qualifies = cart.items_subtotal_price >= THRESHOLD;

    if (qualifies && !gift) {
      await addGift();
      return;
    }

    if (!qualifies && gift) {
      await removeGift();
      return;
    }

    if (qualifies && gift && gift.quantity !== 1) {
      await fetch('/cart/change.js', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id: GIFT_VARIANT_ID, quantity: 1 })
      });
    }

    updateMessage(cart);
  }

  /* ðŸ”¥ INTERCEPT SHOPIFY CART REQUESTS ðŸ”¥ */
  const originalFetch = window.fetch;
  window.fetch = async function () {
    const response = await originalFetch.apply(this, arguments);

    if (
      arguments[0].includes('/cart/add') ||
      arguments[0].includes('/cart/change') ||
      arguments[0].includes('/cart/update')
    ) {
      setTimeout(handleFreeGift, 300);
    }

    return response;
  };

  handleFreeGift();
});
