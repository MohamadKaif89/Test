{% if section.settings.enable_free_gift %}

<!-- ================= FREE GIFT MESSAGE UI ================= -->
<div
  id="free-gift-message"
  style="
    display:none;
    padding:12px;
    margin:12px 0;
    background:#f3f9f4;
    border:1px solid #4caf50;
    color:#2e7d32;
    font-size:14px;
  "
></div>

<script>
/* =========================================================
   FREE GIFT CONFIG (FROM THEME CUSTOMIZER)
========================================================= */
const freeGiftConfig = {
  enabled: {{ section.settings.enable_free_gift | json }},
  threshold: {{ section.settings.threshold_amount | times: 100 }},
  productHandle: "{{ section.settings.free_gift_product.handle }}",
  successMessage: "{{ section.settings.message_text }}",
  showProgress: {{ section.settings.show_progress_message | json }},
  progressMessage: "{{ section.settings.progress_message }}"
};

let isProcessingFreeGift = false;

/* =========================================================
   CART HELPERS (NO CACHE)
========================================================= */
async function getCart() {
  const res = await fetch('/cart.js', { cache: 'no-store' });
  return res.json();
}

async function getGiftVariantId() {
  const res = await fetch(`/products/${freeGiftConfig.productHandle}.js`);
  const product = await res.json();
  return product.variants[0].id; // Auto: first available variant
}

async function addFreeGift(variantId) {
  await fetch('/cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: variantId,
      quantity: 1,
      properties: { _free_gift: 'true' }
    })
  });
}

async function removeFreeGift(lineItemKey) {
  await fetch('/cart/change.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: lineItemKey,
      quantity: 0
    })
  });
}

/* =========================================================
   CORE FREE GIFT LOGIC
========================================================= */
async function handleFreeGift() {

  if (!freeGiftConfig.enabled || !freeGiftConfig.productHandle) return;
  if (isProcessingFreeGift) return;

  isProcessingFreeGift = true;

  const cart = await getCart();
  const giftVariantId = await getGiftVariantId();
  const messageBox = document.getElementById('free-gift-message');

  const freeGiftItem = cart.items.find(
    item => item.variant_id === giftVariantId
  );

  /* ===== THRESHOLD MET ===== */
  if (cart.total_price >= freeGiftConfig.threshold) {

    messageBox.innerHTML = freeGiftConfig.successMessage;
    messageBox.style.display = 'block';

    if (!freeGiftItem) {
      await addFreeGift(giftVariantId);
      await handleFreeGift();
    }

  } 
  /* ===== BELOW THRESHOLD ===== */
  else {

    if (freeGiftConfig.showProgress) {
      const remaining = freeGiftConfig.threshold - cart.total_price;
      const formattedAmount = (remaining / 100).toFixed(2);

      messageBox.innerHTML =
        freeGiftConfig.progressMessage.replace('{{amount}}', formattedAmount);

      messageBox.style.display = 'block';
    } else {
      messageBox.style.display = 'none';
    }

    if (freeGiftItem) {
      await removeFreeGift(freeGiftItem.key);
      await handleFreeGift();
    }
  }

  isProcessingFreeGift = false;
}

/* =========================================================
   INIT + CART CHANGE LISTENERS
========================================================= */
document.addEventListener('DOMContentLoaded', handleFreeGift);
document.addEventListener('cart:updated', handleFreeGift);

(function () {
  const originalFetch = window.fetch;
  window.fetch = function () {
    return originalFetch.apply(this, arguments).then(response => {
      if (response.url.includes('/cart')) {
        setTimeout(handleFreeGift, 300);
      }
      return response;
    });
  };
})();
</script>

{% endif %}

{% schema %}
{
  "name": "Free Gift on Cart Threshold",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_free_gift",
      "label": "Enable Free Gift",
      "default": true
    },
    {
      "type": "number",
      "id": "threshold_amount",
      "label": "Threshold Amount",
      "default": 1000
    },
    {
      "type": "product",
      "id": "free_gift_product",
      "label": "Free Gift Product"
    },
    {
      "type": "text",
      "id": "message_text",
      "label": "Success Message",
      "default": "üéÅ You've unlocked a free gift!"
    },
    {
      "type": "checkbox",
      "id": "show_progress_message",
      "label": "Show Progress Message",
      "default": true
    },
    {
      "type": "text",
      "id": "progress_message",
      "label": "Progress Message",
      "default": "Add {{amount}} more to get a free gift"
    }
  ]
}
{% endschema %}
