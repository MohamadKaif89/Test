{% if section.settings.enable_free_gift %}

<script>
/*
  Free Gift on Cart Threshold
  Simple, clean, test-ready logic
*/

const freeGiftSettings = {
  enabled: {{ section.settings.enable_free_gift | json }},
  threshold: {{ section.settings.threshold_amount | times: 100 }},
  productHandle: "{{ section.settings.free_gift_product.handle }}",
  message: "{{ section.settings.message_text }}"
};

let processing = false;

/* ---------- Helpers ---------- */

async function getCart() {
  const res = await fetch('/cart.js', { cache: 'no-store' });
  return res.json();
}

async function getFreeGiftVariantId() {
  const res = await fetch(`/products/${freeGiftSettings.productHandle}.js`);
  const product = await res.json();
  return product.variants[0].id; // first available variant
}

async function addFreeGift(variantId) {
  await fetch('/cart/add.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: variantId,
      quantity: 1,
      properties: { _free_gift: 'true' }
    })
  });
}

async function removeFreeGift(lineKey) {
  await fetch('/cart/change.js', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      id: lineKey,
      quantity: 0
    })
  });
}

/* ---------- Core Logic ---------- */

async function handleFreeGift() {
  if (!freeGiftSettings.enabled || processing || !freeGiftSettings.productHandle) return;

  processing = true;

  const cart = await getCart();
  const giftVariantId = await getFreeGiftVariantId();

  const freeGiftItem = cart.items.find(
    item => item.variant_id === giftVariantId
  );

  // Threshold met → ensure gift exists
  if (cart.total_price >= freeGiftSettings.threshold) {
    if (!freeGiftItem) {
      await addFreeGift(giftVariantId);
    }
  }

  // Threshold not met → remove gift
  if (cart.total_price < freeGiftSettings.threshold && freeGiftItem) {
    await removeFreeGift(freeGiftItem.key);
  }

  processing = false;
}

/* ---------- Run on load + cart updates ---------- */

document.addEventListener('DOMContentLoaded', handleFreeGift);
document.addEventListener('cart:updated', handleFreeGift);

</script>

{% endif %}

{% schema %}
{
  "name": "Free Gift on Cart Threshold",
  "settings": [
    {
      "type": "checkbox",
      "id": "enable_free_gift",
      "label": "Enable Free Gift",
      "default": true
    },
    {
      "type": "number",
      "id": "threshold_amount",
      "label": "Threshold Amount",
      "default": 1000
    },
    {
      "type": "product",
      "id": "free_gift_product",
      "label": "Free Gift Product"
    },
    {
      "type": "text",
      "id": "message_text",
      "label": "Message Text",
      "default": \"You've unlocked a free gift!\"
    }
  ]
}
{% endschema %}
