<script>
  const threeSholdPrice = {{ settings.free_gift_threshold }};
  const variantId = {{ freeproduct.selected_or_first_available_variant.id }};
  const showProgress = {{ settings.free_gift_show_progress | json }};
  const progressText = "{{ settings.free_gift_progress_message }}";

  let running = false;

  async function getCartData() {
    console.log('Fetching cart.js');
    const res = await fetch('/cart.js', { cache: 'no-store' });
    return res.json();
  }

  async function addFreeGift() {
    console.log('Adding free gift');
    await fetch('/cart/add.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: variantId,
        quantity: 1,
        properties: { _free_gift: 'true' }
      })
    });
  }

  async function removeFreeGift(lineKey) {
    console.log('Removing free gift');
    await fetch('/cart/change.js', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({
        id: lineKey,
        quantity: 0
      })
    });
  }

  async function handleFreeGift() {
    if (running) return;
    running = true;

    const cart = await getCartData();
    const cartTotalPr = Number((cart.total_price / 100).toFixed(2));

    console.log('Cart total:', cartTotalPr);

    const giftItem = cart.items.find(
      item => item.variant_id == variantId
    );

    const giftMsg = document.getElementById('free-gift-message');
    const progressMsg = document.getElementById('free-gift-progress');

    if (cartTotalPr >= threeSholdPrice) {
      giftMsg.style.display = 'block';
      progressMsg.style.display = 'none';

      if (!giftItem) {
        await addFreeGift();
      }
    } else {
      giftMsg.style.display = 'none';

      if (showProgress) {
        const remaining = (threeSholdPrice - cartTotalPr).toFixed(2);
        progressMsg.innerText =
          progressText.replace('{{amount}}', remaining);
        progressMsg.style.display = 'block';
      }

      if (giftItem) {
        await removeFreeGift(giftItem.key);
      }
    }

    running = false;
  }

  // 1️⃣ Run once on page load
  document.addEventListener('DOMContentLoaded', handleFreeGift);

  // 2️⃣ Run after cart UI actions (safe & manual)
  document.addEventListener('click', function (e) {
    if (
      e.target.closest('[name="updates[]"]') ||
      e.target.closest('.cart-remove') ||
      e.target.closest('button')
    ) {
      setTimeout(handleFreeGift, 500);
    }
  });
</script>
