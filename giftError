<h1> ThreeShold Price Demo</h1>

{% comment %} Build tier list from section blocks {% endcomment %}
{% assign tiers = '' %}
{% for block in section.blocks %}
  {% assign p = all_products[block.settings.product] %}
  {% if p %}
    {% assign v = p.selected_or_first_available_variant.id %}
    {% assign t = block.settings.threshold | plus: 0 %}
    {% assign tiers = tiers | append: '{"threshold":' | append: t | append:',"variant":' | append: v | append:'},' %}
  {% endif %}
{% endfor %}
{% if tiers != '' %}
  {% assign tiers = tiers | slice: 0, -1 %}
{% endif %}

{% style %}
#free-gift-message{
  margin: 10px 0;
  color: green;
  display: none;
  text-align: center;
  font-size: 2rem;
  font-weight: 800;
}
#free-gift-progress{
  margin: 10px 0;
  color: orange;
  display: none;
  text-align: center;
  font-size: 2rem;
  font-weight: 800;
}
{% endstyle %}

<div id="free-gift-message">You've unlocked a free gift üéÅ</div>
<div id="free-gift-progress"></div>

<script>
  const enableFreeGift = {{ section.settings.free_gift_enable }};
  const showProgress = {{ section.settings.free_gift_show_progress | json }};
  const progressText = {{ section.settings.free_gift_progress_message | json }};
  const tierList = [{{ tiers | default: '' }}];

  let running = false;

  // Remove gift if feature disabled
  if (!enableFreeGift) {
    disableRemoveFreeGift();
  }

  async function disableRemoveFreeGift() {
    const items = {{ cart.items | json }};
    const remove_gift = items.find(
      item => tierList.some(t => t.variant == item.variant_id)
    );
    if (remove_gift) {
      await removeFreeGift(remove_gift.key);
      cartItemUpdate();
    }
  }

  async function getCartData() {
    const res = await fetch('/cart.js');
    return res.json();
  }

  async function addFreeGift(id) {
    await fetch('/cart/add.js', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        id:id,
        quantity:1,
        properties:{_free_gift:'true'}
      })
    });
  }

  async function removeFreeGift(key) {
    await fetch('/cart/change.js', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({
        id:key,
        quantity:0
      })
    });
  }

  async function handleFreeGift(){

    if(!enableFreeGift){
      return;
    }

    if(running){
      return;
    }

    running = true;

    const cart = await getCartData();
    const cartTotalPr = Number((cart.total_price / 100).toFixed(2));

    const giftItem = cart.items.find(
      item => tierList.some(t => t.variant == item.variant_id)
    );

    const giftMsg = document.getElementById('free-gift-message');
    const progressMsg = document.getElementById('free-gift-progress');

    let activeTier = null;

    tierList.forEach(t=>{
      if(cartTotalPr >= t.threshold){
        activeTier = t;
      }
    });

    const lowestTier = tierList.length ? Math.min(...tierList.map(t=>t.threshold)) : null;

    // Progress message
    if(showProgress && lowestTier && cartTotalPr < lowestTier){
      const rem = (lowestTier - cartTotalPr).toFixed(2);
      progressMsg.innerText = progressText.replace('{{amount}}', rem);
      progressMsg.style.display = 'block';
    } else {
      progressMsg.style.display = 'none';
    }

    // BELOW ALL TIERS ‚Üí remove gift
    if(!activeTier){

      giftMsg.style.display = 'none';

      if(giftItem){
        await removeFreeGift(giftItem.key);
        cartItemUpdate();
      }

      running = false;
      return;
    }

    // Unlocked message
    giftMsg.style.display = 'block';

    // WRONG GIFT ‚Üí replace it
    if(giftItem && giftItem.variant_id != activeTier.variant){
      await removeFreeGift(giftItem.key);
      await addFreeGift(activeTier.variant);
      cartItemUpdate();
      running = false;
      return;
    }

    // FORCE qty = 1
    if(giftItem && giftItem.quantity != 1){
      await fetch('/cart/change.js',{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body:JSON.stringify({
          id: giftItem.key,
          quantity: 1
        })
      });
      cartItemUpdate();
      running = false;
      return;
    }

    // NO GIFT ‚Üí add it
    if(!giftItem){
      await addFreeGift(activeTier.variant);
      cartItemUpdate();
    }

    running = false;
  }

  handleFreeGift();

  function cartItemUpdate(){
    fetch("/?sections=main-cart-items")
    .then(res => res.json())
    .then(res => {
      const html = new DOMParser()
        .parseFromString(res['main-cart-items'],'text/html')
        .querySelector('cart-items');
      document.querySelector('cart-items').innerHTML = html.innerHTML;
    });
  }
</script>
